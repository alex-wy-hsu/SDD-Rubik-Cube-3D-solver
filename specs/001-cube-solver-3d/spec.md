# 功能規格：3D 魔術方塊求解器

**功能分支**：`001-cube-solver-3d`  
**建立日期**：2026-01-03  
**狀態**：草稿  
**輸入**：用戶描述："設計一個可以讓使用者自行解題、演算法自動解題的魔術方塊遊戲。畫面中有一個 3D 魔術方塊，並且一開始已經經過N次隨機的層旋轉。使用者可以按著滑鼠左鍵不放，旋轉魔術方塊的視角，方便玩家檢視。同時我們允許使用者選擇用滑鼠點選哪一個面、哪一行，被選擇的該行在視覺上會被柔和舒服的高亮強調。當某行被選之後，接著提供使用者可以用滑鼠決定要轉哪個方向，用視覺導引的箭頭讓使用者決定要旋轉到哪一面。單次轉動只允許轉 90 度。另外，畫面中只有一個開始解題的按鈕，以及可以切換解題的算法。設計一個用時間複雜度最低的算法版本。設計一個用小型語言模型 (SLM) 解問題的版本，並嵌入到我們的專案內"
## 澄清事項

### 會議 2026-01-03

- Q: 在實作 3D 魔術方塊渲染時，選擇合適的渲染引擎會影響效能、開發速度和跨平台支援。 → A: Three.js（成熟的 WebGL 封裝庫，平衡效能與開發效率）
- Q: SLM 模型選擇與部署方式，需要本地嵌入的輕量開源模型。 → A: Qwen2.5-0.5B/1.5B（Alibaba，超輕量，優化推理，500MB-1.5GB，支援 ONNX Runtime 和 WebGPU）
- Q: 預設打亂次數 N 的具體值（固定或可配置）。 → A: 25（固定）
- Q: 高亮效果的視覺實作方式（影響 Three.js 渲染實作和用戶體驗）。 → A: 發光邊框 + 半透明覆蓋 + 脈動動畫（Outline Pass + 20-30% 透明白色層 + 1-2% 輕微放大縮小）
- Q: 解題動畫中斷時的狀態保存行為（影響狀態管理邏輯）。 → A: 不保存（返回動畫開始前的方塊狀態）

## 用戶場景與測試 *(必填)*

<!--
  重要：用戶故事應依重要性排序。
  每個用戶故事/旅程必須可獨立測試 - 意思是如果您只實作其中一個，
  您仍應有可交付價值的可行 MVP（最小可行產品）。
  
  為每個故事分配優先級（P1、P2、P3 等），其中 P1 是最關鍵的。
  將每個故事視為可以獨立執行的功能切片：
  - 獨立開發
  - 獨立測試
  - 獨立部署
  - 獨立向用戶展示
-->

### 用戶故事 1 - 查看並手動操作 3D 魔術方塊（優先級：P1）

用戶啟動應用程式後，看到一個已打亂的 3×3×3 魔術方塊在 3D 空間中顯示。用戶可以通過拖曳滑鼠來旋轉視角，從不同角度查看方塊。用戶可以點選方塊上的任何面片（facelet），系統會高亮顯示該面所屬的層（layer）。高亮後，系統顯示可用的旋轉方向箭頭（順時針/逆時針），用戶點擊箭頭後，該層會執行 90 度旋轉並播放流暢的動畫。

**為何此優先級**：這是核心互動體驗，沒有這個功能用戶無法使用應用程式。即使沒有自動求解功能，用戶也能夠手動練習魔術方塊，這已經是一個可用的 MVP。

**獨立測試**：啟動應用程式，驗證可以旋轉視角而不改變方塊狀態，點選任一面片可高亮該層，點擊箭頭可執行 90 度旋轉。無需後續功能即可完整測試此功能。

**驗收場景**：

1. **給定** 應用程式剛啟動，**當** 用戶按住滑鼠左鍵並拖曳，**則** 相機視角旋轉但方塊狀態不改變
2. **給定** 用戶正在查看方塊，**當** 用戶點擊任一面片，**則** 該面片所屬的層被柔和高亮顯示（發光邊框 + 半透明覆蓋 + 輕微脈動）
3. **給定** 某一層已被高亮，**當** 用戶點擊順時針箭頭，**則** 該層順時針旋轉 90 度並播放動畫（150-300ms）
4. **給定** 某一層已被高亮，**當** 用戶點擊逆時針箭頭，**則** 該層逆時針旋轉 90 度並播放動畫
5. **給定** 用戶已執行任意次數的手動旋轉，**當** 查看方塊狀態，**則** 方塊仍然是合法的可解狀態

---

### 用戶故事 2 - 使用演算法自動求解（優先級：P2）

用戶在手動操作方塊後（或使用初始打亂狀態），可以點擊「開始解題」按鈕。系統使用預設的最佳化演算法（例如 Kociemba 或類似的兩階段演算法）計算解法，並在畫面上顯示演算法名稱、步數、計算耗時。系統以動畫方式逐步執行解法，最終將方塊恢復到已解狀態（所有面單色）。

**為何此優先級**：自動求解是核心價值主張之一，讓用戶看到演算法如何解決問題。這是在手動互動基礎上的增值功能，優先於 SLM 版本因為演算法版本更可靠、更快速。

**獨立測試**：打亂方塊（或使用初始狀態），點擊「開始解題」按鈕，驗證系統顯示解法資訊並成功將方塊恢復到已解狀態。可以獨立於 SLM 功能進行測試。

**驗收場景**：

1. **給定** 方塊處於打亂狀態，**當** 用戶點擊「開始解題」按鈕，**則** 系統在 200ms 內計算出解法並顯示步數
2. **給定** 解法計算完成，**當** 動畫開始播放，**則** 系統逐步執行每個移動並更新方塊狀態
3. **給定** 解法動畫正在播放，**當** 所有步驟完成，**則** 方塊恢復到已解狀態（六個面各自單色）
4. **給定** 解法動畫正在播放，**當** 用戶嘗試手動旋轉層，**則** 系統禁止操作並僅允許相機旋轉
5. **給定** 解法動畫正在播放，**當** 用戶點擊「停止」按鈕，**則** 動畫停止於當前狀態

---

### 用戶故事 3 - 切換並使用 SLM 求解（優先級：P3）

用戶可以在介面上切換求解演算法，選擇「SLM 版本」（嵌入的小型語言模型）。當選擇 SLM 版本並點擊「開始解題」後，系統使用 SLM 生成解法步驟。如果 SLM 輸出非法移動或無法解決，系統會偵測錯誤並回退到演算法版本，同時向用戶顯示降級訊息。

**為何此優先級**：SLM 求解是實驗性功能，提供 AI 驅動的替代方案。由於可靠性較低且計算成本較高，優先級低於傳統演算法版本。用戶即使沒有這個功能也能完整使用應用程式。

**獨立測試**：切換到 SLM 模式，點擊「開始解題」，驗證 SLM 能夠生成解法或在失敗時自動降級。可以獨立測試而不影響其他功能。

**驗收場景**：

1. **給定** 用戶在介面上看到演算法切換選項，**當** 用戶選擇「SLM 版本」，**則** 系統標記當前選擇的求解器
2. **給定** 已選擇 SLM 版本且方塊處於打亂狀態，**當** 用戶點擊「開始解題」，**則** 系統使用 SLM 生成解法並顯示計算耗時
3. **給定** SLM 生成了有效解法，**當** 動畫播放，**則** 方塊成功恢復到已解狀態
4. **給定** SLM 生成了非法移動或無法求解，**當** 系統偵測到錯誤，**則** 自動切換到演算法版本並顯示降級訊息
5. **給定** 用戶連續執行 100 次隨機打亂和 SLM 求解，**當** 測試完成，**則** 成功率達到 100%（含降級情況）

---

### 用戶故事 4 - 初始化和打亂管理（優先級：P1）

應用程式啟動時，系統從已解狀態開始，執行固定 25 次隨機合法移動來生成打亂狀態。系統記錄並顯示打亂種子（scramble seed），以便重現相同的打亂。用戶可以點擊「重新打亂」按鈕生成新的打亂狀態。

**為何此優先級**：確保每次啟動時方塊狀態是合法且可解的，這是所有其他功能的前提。與故事 1 同等重要，因為沒有打亂就沒有遊戲。

**獨立測試**：啟動應用程式，驗證方塊處於打亂狀態且顯示 seed，點擊「重新打亂」生成新狀態。可以獨立測試打亂功能。

**驗收場景**：

1. **給定** 應用程式剛啟動，**當** 3D 場景載入完成，**則** 方塊顯示為已打亂狀態（25 次移動）
2. **給定** 方塊處於打亂狀態，**當** 用戶查看介面，**則** 畫面顯示當前打亂的 seed 編號
3. **給定** 用戶想要新的挑戰，**當** 用戶點擊「重新打亂」按鈕，**則** 系統生成新的隨機打亂並更新 seed
4. **給定** 顯示了某個 seed，**當** 用戶使用相同 seed 重新啟動，**則** 方塊呈現完全相同的打亂狀態
5. **給定** 系統執行任意打亂，**當** 檢查方塊狀態，**則** 狀態必然是合法且可被求解器解決的

---

### 邊界情況

- 當用戶在解題動畫播放時關閉應用程式會發生什麼？系統應安全終止，不保存動畫中間狀態，下次啟動時返回動畫開始前的方塊狀態（或重新打亂）
- 當 SLM 模型載入失敗或回應超時時如何處理？系統必須偵測並自動降級到演算法版本
- 當用戶連續快速點擊多個箭頭會發生什麼？系統應該排隊處理或忽略後續點擊直到當前動畫完成
- 當用戶嘗試在非法狀態下求解（理論上不應發生）時，求解器應回報錯誤而非崩潰
- 當 SLM 推理時間超過預期（>5秒）時，系統應顯示進度指示並允許用戶取消

## 需求 *(必填)*

### 功能需求

**方塊渲染與互動**
- **FR-001**：系統必須在 3D 空間中渲染一個 3×3×3 魔術方塊，使用標準配色方案（白對黃、紅對橙、藍對綠）
- **FR-002**：系統必須支援滑鼠左鍵拖曳來旋轉相機視角（環繞方塊），但不改變方塊本身的狀態
- **FR-003**：用戶必須能夠點擊方塊上的任一面片，系統高亮顯示該面片所屬的層（3×3 個面片），高亮效果包含：(1) 發光邊框（Outline Pass）、(2) 20-30% 透明度的白色覆蓋層、(3) 1-2% 幅度的輕微脈動動畫（週期 1.5-2 秒）
- **FR-004**：系統必須在層被選中後顯示旋轉方向箭頭（順時針和逆時針），箭頭位置和方向應清楚表達旋轉效果
- **FR-005**：系統必須在用戶點擊箭頭後執行該層 90 度旋轉，並播放流暢的動畫（持續時間 150-300ms）
- **FR-006**：系統必須在動畫播放期間禁止用戶進行其他層旋轉操作，但允許相機視角旋轉

**打亂與初始化**
- **FR-007**：系統必須在啟動時從已解狀態開始，執行 25 次隨機合法移動生成打亂狀態（固定值，不可配置）
- **FR-008**：系統必須記錄並顯示打亂的 seed 編號，使相同 seed 可重現相同打亂
- **FR-009**：系統必須提供「重新打亂」功能，生成新的隨機打亂並更新 seed
- **FR-010**：系統必須確保所有生成的打亂狀態都是合法且可解的（通過應用合法移動序列產生）

**演算法求解**
- **FR-011**：系統必須實作至少一種高效的魔術方塊求解演算法（例如 Kociemba 兩階段演算法或類似方法）
- **FR-012**：系統必須在用戶點擊「開始解題」按鈕後計算解法，並顯示演算法名稱、步數和計算耗時
- **FR-013**：系統必須以動畫方式逐步執行解法，每步移動使用與手動操作相同的動畫效果
- **FR-014**：系統必須在解題動畫播放期間禁止手動旋轉層，但允許相機視角旋轉
- **FR-015**：系統必須提供「停止」功能，允許用戶中斷解題動畫並返回動畫開始前的方塊狀態（不保存中間狀態）
- **FR-016**：系統必須驗證解法執行後方塊處於已解狀態（所有六個面各自單色）

**SLM 求解**
- **FR-017**：系統必須整合 Qwen2.5-0.5B 或 Qwen2.5-1.5B 模型（透過 ONNX Runtime），能夠接收方塊狀態並生成解法步驟序列
- **FR-018**：系統必須提供介面讓用戶切換求解器類型（演算法版本或 SLM 版本）
- **FR-019**：系統必須在使用 SLM 求解時顯示當前使用的求解器類型
- **FR-020**：系統必須驗證 SLM 生成的每個移動是否合法（有效的層和方向）
- **FR-021**：系統必須在 SLM 生成非法移動或無法求解時偵測錯誤，自動降級到演算法版本並通知用戶
- **FR-022**：系統必須記錄 SLM 求解的成功率和失敗原因，用於監控和改進
- **FR-023**：系統必須支援 WebGPU 加速（當可用時）以優化 SLM 推理性能

**狀態管理與驗證**
- **FR-024**：系統必須維護方塊的內部狀態表示，追蹤每個面片的顏色和位置
- **FR-025**：系統必須在每次移動後驗證方塊狀態仍然合法（不產生不可能的配置）
- **FR-026**：系統必須支援狀態序列化，以便保存、載入或傳輸方塊配置
- **FR-027**：系統必須提供狀態檢查功能，判斷當前方塊是否處於已解狀態

### 非功能需求（憲章規定）

#### 代碼品質需求
- 所有代碼必須遵循單一職責和 DRY 原則
- 公共 API 必須有文檔
- 代碼必須通過 linting 且零警告
- 方塊狀態邏輯必須與渲染邏輯分離（模型-視圖分離）
- SLM 整合必須通過介面抽象，允許未來替換模型
- **渲染技術**：使用 Three.js 作為 3D 渲染引擎，確保 WebGL 相容性和跨瀏覽器支援
- **SLM 技術**：使用 Qwen2.5-0.5B 或 Qwen2.5-1.5B 模型，透過 ONNX Runtime Web 整合，優先使用 WebGPU 後備 WASM

#### 測試需求（不可妥協）
- 所有功能必須在實作前編寫測試（TDD）
- 單元測試覆蓋率必須 ≥80%
- 所有用戶故事必須有整合測試
- 測試必須涵蓋邊界情況和錯誤條件
- 必須有專門測試驗證：連續 100 次打亂+求解的成功率達 100%
- 必須有測試驗證 SLM 降級機制正確運作

#### 用戶體驗需求
- 視覺元素必須遵循一致的渲染慣例（配色、光照、材質）
- 用戶操作必須提供即時反饋（高亮效果、箭頭顯示立即回應）- **高亮效果**：必須組合發光邊框、半透明覆蓋和輕微脈動，确保柔和舒適且不產生視覺疲勞，脈動週期應為 1.5-2 秒- 錯誤訊息必須清晰且可操作（例如「SLM 求解失敗，已切換到演算法版本」）
- UI 必須支援鍵盤導航（可選）
- 高亮效果必須柔和舒適，不產生閃爍或視覺疲勞

#### 性能需求
- **渲染性能**：3D 場景在相機旋轉和方塊動畫期間必須維持 ≥30 FPS（目標 60 FPS）
- **演算法求解**：演算法版本求解時間 P95 必須 <200ms（在定義的基準硬體上）
- **SLM 求解**：Qwen2.5 模型推理時間（單次請求）必須在 <5 秒內完成，模型載入時間必須 <10 秒
- **狀態驗證**：方塊狀態合法性檢查必須在 <10ms 內完成
- **打亂生成**：25 次隨機移動的打亂生成必須在 <100ms 內完成
- **記憶體使用**：應用程式基礎記憶體佔用必須保持在 200MB 以下（不含 SLM 模型），載入 SLM 後總記憶體應 <2GB
- **初始載入**：應用程式啟動到首次可互動必須在 <3 秒內完成（不含 SLM 模型預載入）
- **動畫流暢度**：層旋轉動畫不得出現卡頓，frame time 波動必須 <16ms

#### 可靠性需求
- 系統在任何狀態下都不得產生非法方塊配置
- 求解器在遇到合法狀態時不得失敗或崩潰
- SLM 求解失敗時必須優雅降級，不得影響應用程式穩定性
- 連續 100 次打亂+求解測試成功率必須達 100%
- 應用程式必須處理異常情況（例如模型載入失敗）而不崩潰

### 關鍵實體

- **CubeState**：代表魔術方塊的當前配置，包含 54 個面片（6 面 × 9 片）的顏色和位置資訊。必須支援狀態驗證、序列化和比較操作。
  
- **Move**：代表一次方塊操作，包含層標識（U/D/L/R/F/B）和方向（順時針 90°、逆時針 90°、180°）。必須驗證移動合法性。

- **Scramble**：代表一個打亂序列，包含 seed 和移動列表。必須可重現相同的打亂結果。

- **Solution**：代表求解結果，包含移動序列、步數、計算耗時和使用的求解器類型。必須可應用於當前方塊狀態。

- **Solver（介面）**：抽象求解器，定義 `solve(CubeState)` 方法。有兩種實作：AlgorithmSolver（傳統演算法）和 SLMSolver（語言模型）。

- **Animation**：代表一個層旋轉動畫，包含開始時間、持續時間、目標狀態。負責插值和渲染更新。

## 成功標準 *(必填)*

### 可衡量的結果

**功能完整性**
- **SC-001**：用戶可以在 5 秒內完成首次手動層旋轉（從啟動到完成一次旋轉操作）
- **SC-002**：演算法求解器在 95% 的情況下可在 200ms 內計算出解法（P95 < 200ms）
- **SC-003**：連續執行 100 次隨機打亂加求解測試，成功率達到 100%（無崩潰、無非法狀態）

**性能表現**
- **SC-004**：3D 場景在相機旋轉時維持平均 45 FPS 以上（目標硬體：定義的基準配置）
- **SC-005**：層旋轉動畫流暢度達到 90% 的幀保持在 ≥30 FPS（動畫期間）
- **SC-006**：應用程式從啟動到首次可互動時間中位數 <2.5 秒

**用戶體驗**
- **SC-007**：用戶在首次使用時可以在不查看說明的情況下完成至少一次手動旋轉操作（觀察測試 10 位用戶，成功率 ≥80%）
- **SC-008**：高亮效果和箭頭導引被測試用戶評為「清楚易懂」（5 分制評分平均 ≥4 分）
- **SC-009**：演算法求解動畫被測試用戶評為「流暢且易於跟隨」（5 分制評分平均 ≥4 分）

**可靠性**
- **SC-010**：SLM 求解器在生成非法移動時，降級機制 100% 成功切換到演算法版本且不產生錯誤狀態
- **SC-011**：應用程式在連續運行 1 小時（包含多次打亂和求解）後記憶體使用增長 <10%（無明顯記憶體洩漏）
- **SC-012**：任意合法的方塊狀態都可以被演算法求解器成功解決（100% 成功率）

**開發效率**
- **SC-013**：核心狀態管理邏輯（CubeState、Move）單元測試覆蓋率達到 ≥90%
- **SC-014**：每個用戶故事都有至少一個端到端整合測試可以獨立執行
- **SC-015**：新增一種求解演算法所需的程式碼修改限於 Solver 實作，不影響其他模組（架構可擴展性驗證）
